<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rastreador de Leads Diários</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    .progress-ring__circle {
      transition: stroke-dashoffset 0.35s, stroke 0.35s;
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
    }

    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
  </style>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

  <!-- Tela de Login -->
  <div id="login-container" class="w-full max-w-md bg-white rounded-2xl shadow-lg p-8 text-center">
    <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">Bem-vindo!</h1>
    <p class="text-gray-600 mb-8">Faça login para acessar seu rastreador de leads.</p>
    <button id="signin-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 flex items-center justify-center gap-3">
      <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
        <path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z" />
        <path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z" />
        <path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.222 0-9.519-3.487-11.187-8.264l-6.522 5.025C9.505 39.556 16.227 44 24 44z" />
        <path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C44.572 34.046 48 29.268 48 24c0-1.341-.138-2.65-.389-3.917z" />
      </svg>
      Entrar com Google
    </button>
    <p id="login-error" class="text-red-500 text-sm mt-4"></p>
  </div>

  <div id="app-container" class="w-full max-w-4xl bg-white rounded-2xl shadow-lg p-6 md:p-8 hidden">

    <!-- Cabeçalho Principal -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-6">
      <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Rastreador de Leads</h1>
      <div class="flex items-center gap-4 mt-2 md:mt-0">
        <p id="user-display" class="text-sm text-gray-600"></p>
        <button id="signout-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-3 rounded-lg text-xs transition-colors">Sair</button>
      </div>
    </div>

    <!-- Controles de Navegação do Mês e Meta Mensal -->
    <div class="flex justify-between items-center mb-6 bg-gray-50 p-3 rounded-lg">
      <button id="prev-month" class="p-2 rounded-full hover:bg-gray-200 transition"><svg class="h-6 w-6 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg></button>
      <div class="flex flex-col sm:flex-row items-center gap-2 sm:gap-6">
        <h2 id="current-month-year" class="text-xl font-semibold text-gray-700 text-center w-48"></h2>
        <div class="flex items-center gap-2">
          <label for="monthly-goal" class="text-sm font-medium text-gray-600">Meta Diária:</label>
          <input type="number" id="monthly-goal" value="10" min="1" class="w-20 p-2 border border-gray-300 rounded-lg text-center focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
        </div>
      </div>
      <button id="next-month" class="p-2 rounded-full hover:bg-gray-200 transition"><svg class="h-6 w-6 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg></button>
    </div>

    <!-- Grid do Calendário -->
    <div id="calendar-grid" class="grid grid-cols-7 gap-2 md:gap-4">
      <div class="text-center font-medium text-xs text-gray-500 py-2">DOM</div>
      <div class="text-center font-medium text-xs text-gray-500 py-2">SEG</div>
      <div class="text-center font-medium text-xs text-gray-500 py-2">TER</div>
      <div class="text-center font-medium text-xs text-gray-500 py-2">QUA</div>
      <div class="text-center font-medium text-xs text-gray-500 py-2">QUI</div>
      <div class="text-center font-medium text-xs text-gray-500 py-2">SEX</div>
      <div class="text-center font-medium text-xs text-gray-500 py-2">SÁB</div>
    </div>

    <!-- Botão de Ação e Dashboard -->
    <div class="mt-8 border-t border-gray-200 pt-8">
      <div class="flex justify-end mb-8">
        <button id="clear-data" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-md">Limpar Dados do Mês</button>
      </div>
      <div id="dashboard" class="bg-gray-50 rounded-xl p-6">
        <h3 id="dashboard-month-name" class="text-lg font-semibold text-gray-800 mb-4">Resumo de </h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
          <div>
            <p class="text-sm text-gray-500">Dias Úteis</p>
            <p id="db-business-days" class="text-2xl font-bold text-gray-900">-</p>
          </div>
          <div>
            <p class="text-sm text-gray-500">Média Diária</p>
            <p id="db-daily-average" class="text-2xl font-bold text-gray-900">-</p>
          </div>
          <div>
            <p class="text-sm text-gray-500">Total de Abordagens</p>
            <p id="db-total-leads" class="text-2xl font-bold text-gray-900">-</p>
          </div>
          <div>
            <p class="text-sm text-gray-500">Abordagens Esperadas</p>
            <p id="db-expected-leads" class="text-2xl font-bold text-gray-900">-</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, onSnapshot, writeBatch, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAc6UkuJzca-S27dWuX9aUsHS8KQ0ZK75I",
      authDomain: "leads-tracker-479a0.firebaseapp.com",
      projectId: "leads-tracker-479a0",
      storageBucket: "leads-tracker-479a0.firebasestorage.app",
      messagingSenderId: "212835743147",
      appId: "1:212835743147:web:b4d0e1e54ab7d095120eee"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const appId = 'default-app-id'; // Usando um ID padrão para este app
    let userId = null;

    let leadsData = {};
    let monthlyGoals = {};
    let unsubscribeLeads = () => { };
    let unsubscribeGoals = () => { };

    document.addEventListener('DOMContentLoaded', () => {
      const loginContainer = document.getElementById('login-container');
      const appContainer = document.getElementById('app-container');
      const signinBtn = document.getElementById('signin-btn');
      const signoutBtn = document.getElementById('signout-btn');
      const loginError = document.getElementById('login-error');
      const userDisplay = document.getElementById('user-display');

      const calendarGrid = document.getElementById('calendar-grid');
      const currentMonthYearEl = document.getElementById('current-month-year');
      const prevMonthBtn = document.getElementById('prev-month');
      const nextMonthBtn = document.getElementById('next-month');
      const monthlyGoalInput = document.getElementById('monthly-goal');
      const clearDataBtn = document.getElementById('clear-data');

      const dashboardMonthName = document.getElementById('dashboard-month-name');
      const dbBusinessDays = document.getElementById('db-business-days');
      const dbDailyAverage = document.getElementById('db-daily-average');
      const dbTotalLeads = document.getElementById('db-total-leads');
      const dbExpectedLeads = document.getElementById('db-expected-leads');

      let currentDate = new Date();
      const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

      // --- Lógica de Autenticação ---
      const provider = new GoogleAuthProvider();

      signinBtn.addEventListener('click', async () => {
        loginError.textContent = '';
        try {
          await signInWithPopup(auth, provider);
        } catch (error) {
          console.error("Erro no login com Google:", error);
          loginError.textContent = "Falha ao tentar fazer login. Tente novamente.";
        }
      });

      signoutBtn.addEventListener('click', async () => {
        try {
          await signOut(auth);
        } catch (error) {
          console.error("Erro ao sair:", error);
        }
      });

      onAuthStateChanged(auth, (user) => {
        if (user) {
          // Usuário está logado
          userId = user.uid;
          userDisplay.textContent = user.displayName || user.email;
          loginContainer.classList.add('hidden');
          appContainer.classList.remove('hidden');
          setupListeners();
          updateUI();
        } else {
          // Usuário está deslogado
          userId = null;
          appContainer.classList.add('hidden');
          loginContainer.classList.remove('hidden');
          // Limpa dados e listeners
          unsubscribeLeads();
          unsubscribeGoals();
          leadsData = {};
          monthlyGoals = {};
        }
      });

      // --- Lógica da Aplicação ---
      async function setupListeners() {
        if (!userId) return;
        unsubscribeLeads();
        unsubscribeGoals();

        const goalsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'goals');
        unsubscribeGoals = onSnapshot(goalsCollectionRef, (snapshot) => {
          monthlyGoals = {}; // Limpa para evitar dados de usuários antigos
          snapshot.forEach(doc => {
            monthlyGoals[doc.id] = doc.data().goal;
          });
          updateUI();
        });

        const leadsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'leads');
        unsubscribeLeads = onSnapshot(leadsCollectionRef, (snapshot) => {
          leadsData = {}; // Limpa para evitar dados de usuários antigos
          snapshot.forEach(doc => {
            leadsData[doc.id] = doc.data().count;
          });
          updateUI();
        });
      }

      function getGoalForMonth(date) {
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        return monthlyGoals[monthKey] || 10;
      }

      function getProgressColor(progress) {
        if (progress === 0) return 'stroke-transparent';
        if (progress <= 30) return 'stroke-red-500';
        if (progress <= 70) return 'stroke-yellow-500';
        return 'stroke-green-500';
      }

      function updateUI() {
        if (!userId) return;
        const currentGoal = getGoalForMonth(currentDate);
        monthlyGoalInput.value = currentGoal;
        renderCalendar(currentDate, currentGoal);
        renderDashboard(currentDate, currentGoal);
      }

      function renderDashboard(date, goal) {
        const year = date.getFullYear();
        const month = date.getMonth();
        const monthPrefix = `${year}-${String(month + 1).padStart(2, '0')}`;
        let businessDays = 0;
        let totalLeads = 0;
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        for (let day = 1; day <= daysInMonth; day++) {
          const loopDate = new Date(year, month, day);
          const dayOfWeek = loopDate.getDay();
          if (dayOfWeek > 0 && dayOfWeek < 6) businessDays++;
        }
        for (const key in leadsData) {
          if (key.startsWith(monthPrefix)) totalLeads += leadsData[key];
        }
        const dailyAverage = businessDays > 0 ? (totalLeads / businessDays).toFixed(1) : 0;
        const expectedLeads = businessDays * goal;
        dashboardMonthName.textContent = `Resumo de ${monthNames[month]}`;
        dbBusinessDays.textContent = businessDays;
        dbDailyAverage.textContent = dailyAverage;
        dbTotalLeads.textContent = totalLeads;
        dbExpectedLeads.textContent = expectedLeads;
      }

      function renderCalendar(date, goal) {
        const dayHeaders = Array.from(calendarGrid.querySelectorAll('.text-xs'));
        calendarGrid.innerHTML = '';
        dayHeaders.forEach(header => calendarGrid.appendChild(header));
        const year = date.getFullYear();
        const month = date.getMonth();
        currentMonthYearEl.textContent = `${monthNames[month]} ${year}`;
        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        for (let i = 0; i < firstDayOfMonth; i++) { calendarGrid.appendChild(document.createElement('div')); }
        for (let day = 1; day <= daysInMonth; day++) {
          const dayCell = document.createElement('div');
          const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const leadsCount = leadsData[dateKey] || 0;
          const progress = goal > 0 ? Math.min((leadsCount / goal) * 100, 100) : 0;
          const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();
          dayCell.className = `relative p-2 border border-gray-200 rounded-lg shadow-sm flex flex-col items-center justify-start aspect-square transition ${isToday ? 'bg-blue-50' : 'bg-white'}`;
          dayCell.dataset.date = dateKey;
          const radius = 16;
          const circumference = 2 * Math.PI * radius;
          const offset = circumference - (progress / 100) * circumference;
          const progressColor = getProgressColor(progress);
          dayCell.innerHTML = `
                        <div class="relative w-10 h-10 flex items-center justify-center mb-1">
                            <svg class="w-full h-full" viewBox="0 0 36 36">
                                <circle class="stroke-current text-gray-200" stroke-width="3" fill="transparent" r="${radius}" cx="18" cy="18"/>
                                <circle class="progress-ring__circle stroke-current ${progressColor}" stroke-width="3" stroke-linecap="round" fill="transparent" r="${radius}" cx="18" cy="18" style="stroke-dasharray: ${circumference} ${circumference}; stroke-dashoffset: ${offset};"/>
                            </svg>
                            <span class="absolute text-sm font-semibold text-gray-700">${day}</span>
                        </div>
                        <input type="number" value="${leadsCount > 0 ? leadsCount : ''}" placeholder="-" class="w-full text-center bg-transparent border-none text-gray-800 font-semibold text-base focus:outline-none focus:ring-0 p-0">
                    `;
          calendarGrid.appendChild(dayCell);
        }
      }

      async function updateLeadsCount(dateKey, count) {
        const docRef = doc(db, 'artifacts', appId, 'users', userId, 'leads', dateKey);
        await setDoc(docRef, { count: count });
      }

      async function updateMonthlyGoal(date, goal) {
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        const docRef = doc(db, 'artifacts', appId, 'users', userId, 'goals', monthKey);
        await setDoc(docRef, { goal: goal });
      }

      prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); updateUI(); });
      nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); updateUI(); });

      monthlyGoalInput.addEventListener('change', () => {
        let newGoal = parseInt(monthlyGoalInput.value, 10) || 1;
        if (newGoal < 1) newGoal = 1;
        monthlyGoalInput.value = newGoal;
        updateMonthlyGoal(currentDate, newGoal);
      });

      calendarGrid.addEventListener('input', (e) => {
        if (e.target.tagName === 'INPUT') {
          const dayCell = e.target.closest('[data-date]');
          if (dayCell) {
            const dateKey = dayCell.dataset.date;
            let leadsCount = parseInt(e.target.value, 10) || 0;
            if (leadsCount < 0) leadsCount = 0;
            e.target.value = leadsCount > 0 ? leadsCount : '';
            updateLeadsCount(dateKey, leadsCount);
          }
        }
      });

      clearDataBtn.addEventListener('click', async () => {
        const year = currentDate.getFullYear();
        const month = String(currentDate.getMonth() + 1).padStart(2, '0');
        if (!confirm(`Tem certeza que deseja limpar todos os dados de ${monthNames[currentDate.getMonth()]} ${year}?`)) return;
        const leadsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'leads');
        const q = query(leadsCollectionRef, where('__name__', '>=', `${year}-${month}`), where('__name__', '<', `${year}-${String(parseInt(month, 10) + 1).padStart(2, '0')}`));
        const querySnapshot = await getDocs(q);
        const batch = writeBatch(db);
        querySnapshot.forEach((doc) => { batch.delete(doc.ref); });
        await batch.commit();
      });
    });
  </script>

</body>

</html>